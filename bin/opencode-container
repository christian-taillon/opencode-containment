#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Default values (env-overridable)
PROFILE="${OPENCODE_PROFILE:-secure}"
IMAGE="${OPENCODE_IMAGE:-opencode-containment:latest}"
WORKSPACE="${OPENCODE_WORKSPACE:-$PWD}"
OPENCODE_CONTAINER_HOME="${OPENCODE_CONTAINER_HOME:-$HOME/.local/share/opencode-container}"

show_help() {
    cat <<EOF
Usage: opencode-container [OPTIONS] [-- ARGS...]

Options:
  --profile PROFILE   Profile to use: secure or native (default: OPENCODE_PROFILE or secure)
  --image IMAGE       Container image to use (default: OPENCODE_IMAGE or opencode-containment:latest)
  --workspace DIR     Workspace directory to mount (default: OPENCODE_WORKSPACE or current directory)
  --help              Show this help message

Profiles:
  secure: Essential mounts only (opencode config, git config, workspace, persistent cache/state, SSH agent)
  native: secure + nvim config/plugins, sanitized zshrc, nvim state
EOF
}

# Parse arguments
ARGS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        --profile)
            PROFILE="$2"
            shift 2
            ;;
        --image)
            IMAGE="$2"
            shift 2
            ;;
        --workspace)
            WORKSPACE="$2"
            shift 2
            ;;
        --help)
            show_help
            exit 0
            ;;
        --)
            shift
            ARGS+=("$@")
            break
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

# Check prerequisites
if ! command -v docker >/dev/null 2>&1; then
    echo "Error: docker is not installed or not in PATH." >&2
    exit 1
fi

# Ensure persistent directories exist
mkdir -p "$OPENCODE_CONTAINER_HOME"/{cache,local}

# Base docker run arguments
DOCKER_ARGS=(
    --rm
    -it
    --cap-drop=ALL
    --security-opt no-new-privileges:true
    --init
    --user "$(id -u):$(id -g)"
    --env HOME=/home/opencode
    --env EDITOR=nvim
    --env VISUAL=nvim
    --env TERM=xterm-256color
    --env COLORTERM=truecolor
    --workdir /workspace
)

# Load container config override
OVERRIDES_FILE="$SCRIPT_DIR/config/opencode-overrides.json"
if [[ -f "$OVERRIDES_FILE" ]]; then
    DOCKER_ARGS+=(--env "OPENCODE_CONFIG_CONTENT=$(cat "$OVERRIDES_FILE" | tr -d '\n')")
fi

# Pass through OPENCODE_CONFIG_CONTENT if set
if [[ -n "${OPENCODE_CONFIG_CONTENT:-}" ]]; then
    DOCKER_ARGS+=(--env "OPENCODE_CONFIG_CONTENT=$OPENCODE_CONFIG_CONTENT")
fi

# SSH Agent forwarding
if [[ -n "${SSH_AUTH_SOCK:-}" && -S "$SSH_AUTH_SOCK" ]]; then
    DOCKER_ARGS+=(
        --env SSH_AUTH_SOCK=/tmp/ssh-agent.sock
        --volume "$SSH_AUTH_SOCK:/tmp/ssh-agent.sock"
    )
fi

# SSH config and known_hosts
if [[ -f "$HOME/.ssh/config" ]]; then
    DOCKER_ARGS+=(--volume "$HOME/.ssh/config:/home/opencode/.ssh/config:ro")
fi
if [[ -f "$HOME/.ssh/known_hosts" ]]; then
    DOCKER_ARGS+=(--volume "$HOME/.ssh/known_hosts:/home/opencode/.ssh/known_hosts:ro")
fi

# Sync auth.json from host opencode data dir
if [[ -f "$HOME/.local/share/opencode/auth.json" ]]; then
    mkdir -p "$OPENCODE_CONTAINER_HOME/local/share/opencode"
    cp "$HOME/.local/share/opencode/auth.json" "$OPENCODE_CONTAINER_HOME/local/share/opencode/auth.json"
fi

# Secure profile mounts
DOCKER_ARGS+=(
    --volume "$WORKSPACE:/workspace:rw"
    --volume "$HOME/.config/opencode:/home/opencode/.config/opencode:ro"
    --volume "$OPENCODE_CONTAINER_HOME/local:/home/opencode/.local:rw"
    --volume "$OPENCODE_CONTAINER_HOME/cache:/home/opencode/.cache:rw"
)

# Pass through tc credentials if set
[[ -n "${tc_accessid:-}" ]] && DOCKER_ARGS+=(--env "tc_accessid=$tc_accessid")
[[ -n "${tc_secretkey:-}" ]] && DOCKER_ARGS+=(--env "tc_secretkey=$tc_secretkey")

# GCloud config
if [[ -d "$HOME/.config/gcloud" ]]; then
    DOCKER_ARGS+=(--volume "$HOME/.config/gcloud:/home/opencode/.config/gcloud:ro")
fi

# Git config
if [[ -f "$HOME/.gitconfig" ]]; then
    DOCKER_ARGS+=(--volume "$HOME/.gitconfig:/home/opencode/.gitconfig:ro")
fi

# Native profile mounts
if [[ "$PROFILE" == "native" ]]; then
    mkdir -p "$OPENCODE_CONTAINER_HOME/local/share/nvim/site/parser"
    if [[ -d "$HOME/.config/nvim" ]]; then
        DOCKER_ARGS+=(--volume "$HOME/.config/nvim:/home/opencode/.config/nvim:ro")
    fi
    if [[ -d "$HOME/.local/share/nvim" ]]; then
        DOCKER_ARGS+=(--volume "$HOME/.local/share/nvim:/home/opencode/.local/share/nvim:ro")
    fi
    
    # Writable overlay for blink.cmp target directory to allow recompilation
    mkdir -p "$OPENCODE_CONTAINER_HOME/local/share/nvim/lazy/blink.cmp/target"
    DOCKER_ARGS+=(--volume "$OPENCODE_CONTAINER_HOME/local/share/nvim/lazy/blink.cmp/target:/home/opencode/.local/share/nvim/lazy/blink.cmp/target:rw")
    
    DOCKER_ARGS+=(--volume "$OPENCODE_CONTAINER_HOME/local/share/nvim/site/parser:/home/opencode/.local/share/nvim/site/parser:rw")
    # Use isolated persistent state/cache for nvim â€” do NOT mount from host to prevent
    # Alpine container neovim from corrupting the host's nvim state or cache directories.
    mkdir -p "$OPENCODE_CONTAINER_HOME/local/state/nvim" "$OPENCODE_CONTAINER_HOME/cache/nvim"
    DOCKER_ARGS+=(--volume "$OPENCODE_CONTAINER_HOME/local/state/nvim:/home/opencode/.local/state/nvim:rw")
    DOCKER_ARGS+=(--volume "$OPENCODE_CONTAINER_HOME/cache/nvim:/home/opencode/.cache/nvim:rw")
    
    # Sanitized zshrc
    ZSHRC_LOCAL="$SCRIPT_DIR/.zshrc.local"
    if [[ -f "$ZSHRC_LOCAL" ]]; then
        DOCKER_ARGS+=(--volume "$ZSHRC_LOCAL:/home/opencode/.zshrc:ro")
    fi
    
    # Container init script for parser compilation
    DOCKER_ARGS+=(--volume "$SCRIPT_DIR/scripts/container-init.sh:/usr/local/bin/container-init.sh:ro")
elif [[ "$PROFILE" != "secure" ]]; then
    echo "Error: Unknown profile '$PROFILE'. Use 'secure' or 'native'." >&2
    exit 1
fi

# Execute docker run
if [[ "$PROFILE" == "native" ]]; then
    # Native profile: run init script first (compiles tree-sitter parsers if needed)
    if [[ ${#ARGS[@]} -eq 0 ]]; then
        exec docker run "${DOCKER_ARGS[@]}" --entrypoint /usr/local/bin/container-init.sh "$IMAGE" opencode
    else
        exec docker run "${DOCKER_ARGS[@]}" --entrypoint /usr/local/bin/container-init.sh "$IMAGE" "${ARGS[@]}"
    fi
else
    exec docker run "${DOCKER_ARGS[@]}" "$IMAGE" "${ARGS[@]}"
fi
