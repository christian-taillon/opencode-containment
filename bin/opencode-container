#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Default values (env-overridable)
PROFILE="${OPENCODE_PROFILE:-secure}"
IMAGE="${OPENCODE_IMAGE:-opencode-containment:latest}"
WORKSPACE="${OPENCODE_WORKSPACE:-$PWD}"
OPENCODE_CONTAINER_HOME="${OPENCODE_CONTAINER_HOME:-$HOME/.local/share/opencode-container}"

show_help() {
    cat <<EOF
Usage: opencode-container [OPTIONS] [-- ARGS...]

Options:
  --profile PROFILE   Profile to use: secure or native (default: OPENCODE_PROFILE or secure)
  --image IMAGE       Container image to use (default: OPENCODE_IMAGE or opencode-containment:latest)
  --workspace DIR     Workspace directory to mount (default: OPENCODE_WORKSPACE or current directory)
  --help              Show this help message

Profiles:
  secure: Essential mounts only (opencode config, git config, workspace, persistent cache/state, SSH agent)
  native: secure + nvim config/plugins, sanitized zshrc, nvim state

Local overrides (all optional, gitignored by default):
  config/opencode-overrides.local.json  JSON passed as OPENCODE_CONFIG_CONTENT
  config/opencode-container.local.sh    Shell hook for extra env/mount args
EOF
}

# Parse arguments
ARGS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        --profile)
            PROFILE="$2"
            shift 2
            ;;
        --image)
            IMAGE="$2"
            shift 2
            ;;
        --workspace)
            WORKSPACE="$2"
            shift 2
            ;;
        --help)
            show_help
            exit 0
            ;;
        --)
            shift
            ARGS+=("$@")
            break
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

# Validate workspace to prevent host OS breakage
if [[ ! -e "$WORKSPACE" ]]; then
    echo "Error: Workspace path does not exist: $WORKSPACE" >&2
    exit 1
fi
if [[ ! -d "$WORKSPACE" ]]; then
    echo "Error: Workspace path is not a directory: $WORKSPACE" >&2
    exit 1
fi
REAL_WORKSPACE="$(realpath "$WORKSPACE")"
REAL_HOME="$(realpath "$HOME")"
START_DIR="$(realpath "$PWD")"
if [[ "$REAL_WORKSPACE" == "/" || "$REAL_WORKSPACE" == "$REAL_HOME" ]]; then
    echo "Error: For security reasons, mounting '/' or '$HOME' as the workspace is not allowed." >&2
    exit 1
fi
if [[ "$REAL_WORKSPACE" != "$START_DIR" && "$REAL_WORKSPACE" != "$START_DIR"/* ]]; then
    echo "Error: Workspace must be the current directory or one of its subdirectories." >&2
    exit 1
fi

# Check prerequisites
if ! command -v docker >/dev/null 2>&1; then
    echo "Error: docker is not installed or not in PATH." >&2
    exit 1
fi

# Ensure persistent directories exist
mkdir -p "$OPENCODE_CONTAINER_HOME"/{cache,local}

# Base docker run arguments
DOCKER_ARGS=(
    --rm
    -it
    --cap-drop=ALL
    --security-opt no-new-privileges:true
    --read-only
    --tmpfs /tmp:rw,nosuid,nodev,exec,size=256m
    --init
    --user "$(id -u):$(id -g)"
    --env "OPENCODE_PROFILE=$PROFILE"
    --env HOME=/home/opencode
    --env EDITOR=nvim
    --env VISUAL=nvim
    --env TERM=xterm-256color
    --env COLORTERM=truecolor
    --workdir /workspace
)

# Load config overrides with precedence:
# 1) OPENCODE_CONFIG_CONTENT env var
# 2) OPENCODE_OVERRIDES_FILE path (default: config/opencode-overrides.local.json)
OVERRIDES_FILE="${OPENCODE_OVERRIDES_FILE:-$SCRIPT_DIR/config/opencode-overrides.local.json}"
if [[ -n "${OPENCODE_CONFIG_CONTENT:-}" ]]; then
    DOCKER_ARGS+=(--env "OPENCODE_CONFIG_CONTENT=$OPENCODE_CONFIG_CONTENT")
elif [[ -f "$OVERRIDES_FILE" ]]; then
    DOCKER_ARGS+=(--env "OPENCODE_CONFIG_CONTENT=$(tr -d '\n' <"$OVERRIDES_FILE")")
fi

# SSH Agent forwarding
if [[ -n "${SSH_AUTH_SOCK:-}" && -S "$SSH_AUTH_SOCK" ]]; then
    DOCKER_ARGS+=(
        --env SSH_AUTH_SOCK=/tmp/ssh-agent.sock
        --volume "$SSH_AUTH_SOCK:/tmp/ssh-agent.sock:ro"
    )
fi

# SSH config and known_hosts
if [[ -f "$HOME/.ssh/config" ]]; then
    DOCKER_ARGS+=(--volume "$HOME/.ssh/config:/home/opencode/.ssh/config:ro")
fi
if [[ -f "$HOME/.ssh/known_hosts" ]]; then
    DOCKER_ARGS+=(--volume "$HOME/.ssh/known_hosts:/home/opencode/.ssh/known_hosts:ro")
fi

# Secure profile mounts
DOCKER_ARGS+=(
    --volume "$WORKSPACE:/workspace:rw"
    --volume "$HOME/.config/opencode:/home/opencode/.config/opencode:ro"
    --volume "$OPENCODE_CONTAINER_HOME/local:/home/opencode/.local:rw"
    --volume "$OPENCODE_CONTAINER_HOME/cache:/home/opencode/.cache:rw"
)

# Git config
if [[ -f "$HOME/.gitconfig" ]]; then
    DOCKER_ARGS+=(--volume "$HOME/.gitconfig:/home/opencode/.gitconfig:ro")
fi

# Optional local hook for personal env vars or extra mounts.
LOCAL_HOOK="$SCRIPT_DIR/config/opencode-container.local.sh"
if [[ -f "$LOCAL_HOOK" ]]; then
    # shellcheck disable=SC1090
    source "$LOCAL_HOOK"
fi

# Native profile mounts
if [[ "$PROFILE" == "native" ]]; then
    mkdir -p "$OPENCODE_CONTAINER_HOME/local/share/nvim/site/parser"
    if [[ -d "$HOME/.config/nvim" ]]; then
        DOCKER_ARGS+=(--volume "$HOME/.config/nvim:/home/opencode/.config/nvim:ro")
    fi
    if [[ -d "$HOME/.local/share/nvim" ]]; then
        DOCKER_ARGS+=(--volume "$HOME/.local/share/nvim:/home/opencode/.local/share/nvim:ro")
    fi
    
    # Writable overlay for blink.cmp target directory to allow recompilation
    mkdir -p "$OPENCODE_CONTAINER_HOME/local/share/nvim/lazy/blink.cmp/target"
    DOCKER_ARGS+=(--volume "$OPENCODE_CONTAINER_HOME/local/share/nvim/lazy/blink.cmp/target:/home/opencode/.local/share/nvim/lazy/blink.cmp/target:rw")
    
    DOCKER_ARGS+=(--volume "$OPENCODE_CONTAINER_HOME/local/share/nvim/site/parser:/home/opencode/.local/share/nvim/site/parser:rw")
    if [[ -d "$HOME/.local/state/nvim" ]]; then
        DOCKER_ARGS+=(--volume "$HOME/.local/state/nvim:/home/opencode/.local/state/nvim:rw")
    fi
    if [[ -d "$HOME/.cache/nvim" ]]; then
        DOCKER_ARGS+=(--volume "$HOME/.cache/nvim:/home/opencode/.cache/nvim:rw")
    fi
    
    # Sanitized zshrc generated in persistent container state
    HOST_ZSHRC="$HOME/.zshrc"
    SANITIZED_ZSHRC="$OPENCODE_CONTAINER_HOME/local/share/opencode/zshrc_sanitized"
    if [[ -f "$HOST_ZSHRC" ]]; then
        mkdir -p "$(dirname "$SANITIZED_ZSHRC")"
        if [[ ! -f "$SANITIZED_ZSHRC" || "$HOST_ZSHRC" -nt "$SANITIZED_ZSHRC" ]]; then
            if ! bash "$SCRIPT_DIR/scripts/generate-container-zshrc.sh" "$HOST_ZSHRC" "$SANITIZED_ZSHRC"; then
                echo "Warning: failed to regenerate sanitized zshrc; continuing without host zshrc." >&2
            fi
        fi
    fi
    if [[ -f "$SANITIZED_ZSHRC" ]]; then
        DOCKER_ARGS+=(--volume "$SANITIZED_ZSHRC:/home/opencode/.zshrc:ro")
    fi
    
elif [[ "$PROFILE" != "secure" ]]; then
    echo "Error: Unknown profile '$PROFILE'. Use 'secure' or 'native'." >&2
    exit 1
fi

# Execute docker run
if [[ ${#ARGS[@]} -eq 0 ]]; then
    ARGS=(opencode)
fi

exec docker run "${DOCKER_ARGS[@]}" "$IMAGE" "${ARGS[@]}"
